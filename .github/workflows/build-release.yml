name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.0.1, etc.
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller --name="LithophaneGenerator" `
          --windowed `
          --onefile `
          --add-data="README.md;." `
          --hidden-import=vtkmodules `
          --hidden-import=vtkmodules.all `
          --hidden-import=vtkmodules.qt.QVTKRenderWindowInteractor `
          --hidden-import=vtkmodules.util `
          --hidden-import=vtkmodules.util.numpy_support `
          --collect-all=vtk `
          --collect-all=vtkmodules `
          viewer.py

    - name: Get version from tag
      id: get_version
      run: |
        if ($env:GITHUB_REF -match 'refs/tags/v(.*)') {
          $version = $matches[1]
        } else {
          $version = "dev-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Create ZIP archive
      run: |
        Compress-Archive -Path dist/LithophaneGenerator.exe, README.md -DestinationPath LithophaneGenerator-Windows-${{ steps.get_version.outputs.VERSION }}.zip
      shell: pwsh

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: LithophaneGenerator-Windows
        path: LithophaneGenerator-Windows-*.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: LithophaneGenerator-Windows-*.zip
        body: |
          ## ðŸŽ‰ Lithophane Generator Release ${{ steps.get_version.outputs.VERSION }}

          ### ðŸ“¦ ë‹¤ìš´ë¡œë“œ
          Windows ì‚¬ìš©ìžëŠ” ì•„ëž˜ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”:
          - `LithophaneGenerator-Windows-${{ steps.get_version.outputs.VERSION }}.zip`

          ### ðŸš€ ì‚¬ìš© ë°©ë²•
          1. ZIP íŒŒì¼ ì••ì¶• í•´ì œ
          2. `LithophaneGenerator.exe` ì‹¤í–‰
          3. ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì™€ì„œ ë¦¬í† íŽ˜ì¸ìœ¼ë¡œ ë³€í™˜!

          ### âœ¨ ì£¼ìš” ê¸°ëŠ¥
          - ì´ë¯¸ì§€ë¥¼ 3D ë¦¬í† íŽ˜ì¸ìœ¼ë¡œ ìžë™ ë³€í™˜
          - ì‹¤ì‹œê°„ 3D ë¯¸ë¦¬ë³´ê¸°
          - STL íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸° (3D í”„ë¦°íŒ… ê°€ëŠ¥)
          - ì‚¬ìš©ìž ì¹œí™”ì ì¸ GUI

          ### ðŸ“‹ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
          - Windows 10/11 (64-bit)
          - ìµœì†Œ 4GB RAM (8GB ì¶”ì²œ)

          ### ðŸ› ë²„ê·¸ ë¦¬í¬íŠ¸
          ë¬¸ì œê°€ ë°œìƒí•˜ë©´ [Issues](https://github.com/${{ github.repository }}/issues)ì— ë“±ë¡í•´ì£¼ì„¸ìš”.

          ---
          **ì „ì²´ ë³€ê²½ ë‚´ì—­ì€ ì•„ëž˜ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller --name="LithophaneGenerator" \
          --windowed \
          --onefile \
          --add-data="README.md:." \
          --hidden-import=vtkmodules \
          --hidden-import=vtkmodules.all \
          --hidden-import=vtkmodules.qt.QVTKRenderWindowInteractor \
          --hidden-import=vtkmodules.util \
          --hidden-import=vtkmodules.util.numpy_support \
          --collect-all=vtk \
          --collect-all=vtkmodules \
          viewer.py

    - name: Get version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="dev-$(date +%Y%m%d-%H%M%S)"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Create ZIP archive
      run: |
        cd dist
        zip -r ../LithophaneGenerator-macOS-${{ steps.get_version.outputs.VERSION }}.zip LithophaneGenerator.app ../README.md
        cd ..

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: LithophaneGenerator-macOS
        path: LithophaneGenerator-macOS-*.zip

    - name: Add to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: LithophaneGenerator-macOS-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
